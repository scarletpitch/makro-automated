name: Cypress + Lighthouse CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  cypress-run:
    # runs-on: self-hosted
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18
          architecture: arm64

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Run Cypress
        run: npx cypress run

  lighthouse-ci:
    runs-on: self-hosted
    needs: cypress-run

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          architecture: x64

      - name: ğŸ“¦ Install LHCI
        run: npm install -g @lhci/cli

      - name: ğŸ”¦ Run Lighthouse CI
        run: lhci autorun

      - name: ğŸ“¦ Zip Lighthouse report
        run: |
          mkdir -p artifact
          cp -r .lighthouseci/* artifact/
          zip -r lighthouse-report.zip artifact

      - name: ğŸ“¤ Upload zip via custom script
        run: echo "Please manually grab artifact from runner or push to external storage."
