name: Cypress + Lighthouse CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  cypress-run:
    runs-on: self-hosted

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18
          architecture: arm64

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Run Cypress
        run: npx cypress run --spec "cypress/e2e/login/*.cy.js"

  lighthouse-ci:
    runs-on: self-hosted
    needs: cypress-run

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          architecture: arm64

      - name: ğŸ“¦ Install LHCI
        run: npm install -g @lhci/cli

      - name: ğŸ”¦ Run Lighthouse CI
        run: lhci autorun

      - name: ğŸ”„ Prepare upload-artifact action
        uses: actions/upload-artifact@v3

      - name: ğŸ“¤ Upload Lighthouse report
        run: |
          mkdir -p artifact && cp -r .lighthouseci/* artifact/
          echo "::group::Uploading artifact"
          tar -czf report.tar.gz artifact
          echo "::endgroup::"
        continue-on-error: false
